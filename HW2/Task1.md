---
geometry:
-                 margin=10mm
-                 landscape
pagesize:         letter
classoption:      table
header-includes:  \rowcolors{2}{gray!5}{gray!10}
---

# Task 1 - Trace close(fd)

+--------------------------------------------------------------------------+-----------------------------------------+------------------------------------------+--------------------------------------+
|                                  Kernel                                  |                Hardware                 |                   User                   |       File : line Nos. : func        |
+==========================================================================+=========================================+==========================================+======================================+
|                                                                          |                                         | Define uninitialized **`fd`**            | test.c : 6-7 : **`main`**            |
|                                                                          |                                         |                                          |                                      |
|                                                                          |                                         | call **`close(fd)`**                     |                                      |
+--------------------------------------------------------------------------+-----------------------------------------+------------------------------------------+--------------------------------------+
|                                                                          | **`SYS_close`** to **`%eax`**           |                                          | usus.S : 17 : **`close`**            |
|                                                                          |                                         |                                          |                                      |
|                                                                          | return to  **`vector64`**               |                                          |                                      |
+--------------------------------------------------------------------------+-----------------------------------------+------------------------------------------+--------------------------------------+
|                                                                          | call **`alltraps(T_SYSCALL)`**          |                                          | vectors.S : 317-321 : **`vector64`** |
+--------------------------------------------------------------------------+-----------------------------------------+------------------------------------------+--------------------------------------+
|                                                                          | Push trapframe **`tf`** for system call |                                          | trapasm.S : 4-20 : **`alltraps`**    |
|                                                                          |                                         |                                          |                                      |
|                                                                          | call **`trap(tf)`**                     |                                          |                                      |
+--------------------------------------------------------------------------+-----------------------------------------+------------------------------------------+--------------------------------------+
| Check that **`trapno`** is **`T_SYSCALL`**                               |                                         |                                          | trap.c : 39-43 : **`trap`**          |
|                                                                          |                                         |                                          |                                      |
| Set current process **`tf`** with given **`tf`**                         |                                         |                                          |                                      |
|                                                                          |                                         |                                          |                                      |
| call **`syscall()`**                                                     |                                         |                                          |                                      |
+--------------------------------------------------------------------------+-----------------------------------------+------------------------------------------+--------------------------------------+
| Get trap **`num`** from the current process **`curproc`**                |                                         |                                          | syscall.c : 135-139 : **`syscall`**  |
|                                                                          |                                         |                                          |                                      |
| **`syscalls[num] == sys_close`**                                         |                                         |                                          |                                      |
|                                                                          |                                         |                                          |                                      |
| call **`sys_close()`**                                                   |                                         |                                          |                                      |
+--------------------------------------------------------------------------+-----------------------------------------+------------------------------------------+--------------------------------------+
| call **`argfd(0, &fd, &f)`**                                             |                                         |                                          | sysfile.c : 99 : **`sys_close`**     |
+--------------------------------------------------------------------------+-----------------------------------------+------------------------------------------+--------------------------------------+
| Get current process **`fd`** and **`f`**                                 |                                         |                                          | sysfile.c : 29-30 : **`argfd`**      |
|                                                                          |                                         |                                          |                                      |
| **Find that `fd` is invalid**                                            |                                         |                                          |                                      |
|                                                                          |                                         |                                          |                                      |
| **`return -1`** to **`sys_close`**                                       |                                         |                                          |                                      |
+--------------------------------------------------------------------------+-----------------------------------------+------------------------------------------+--------------------------------------+
| **`return -1`** to **`syscall`**                                         |                                         |                                          | sysfile.c : 100 : **`sys_close`**    |
+--------------------------------------------------------------------------+-----------------------------------------+------------------------------------------+--------------------------------------+
| Set current process **`curproc`** return value **`tf->eax`** to **`-1`** |                                         |                                          | syscall.c : 145 : **`syscall`**      |
|                                                                          |                                         |                                          |                                      |
| **`return`** to **`trap`**                                               |                                         |                                          |                                      |
+--------------------------------------------------------------------------+-----------------------------------------+------------------------------------------+--------------------------------------+
| **`return`** to **`alltraps`**                                           |                                         |                                          | trap.c : 46 : **`trap`**             |
+--------------------------------------------------------------------------+-----------------------------------------+------------------------------------------+--------------------------------------+
|                                                                          | Pop trapframe **`tf`**                  |                                          | trapasm.S : 21-32 : **`trapret`**    |
|                                                                          |                                         |                                          |                                      |
|                                                                          | **`return`** to **`main`**              |                                          |                                      |
+--------------------------------------------------------------------------+-----------------------------------------+------------------------------------------+--------------------------------------+
|                                                                          |                                         | **`printf` return value of `close(fd)`** | test.c : 8 : **`main`**              |
+--------------------------------------------------------------------------+-----------------------------------------+------------------------------------------+--------------------------------------+
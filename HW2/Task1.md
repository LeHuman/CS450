# Task 1 - Trace close(fd)

+-------------------------------------------------------------------+------------------------------------------+---------------------------+-------------------------+
|                              Kernel                               |                 Hardware                 |           User            |          File           |
+===================================================================+==========================================+===========================+=========================+
|                                                                   |                                          | Define uninitialized `fd` | test.c : `main`         |
|                                                                   |                                          | > `call close(fd)`        |                         |
|                                                                   |                                          | Trap to OS                |                         |
+-------------------------------------------------------------------+------------------------------------------+---------------------------+-------------------------+
|                                                                   | Build trapframe `tf` for system call     |                           | trapasm.S : `alltraps`  |
|                                                                   | > `call trap(tf)`                        |                           |                         |
+-------------------------------------------------------------------+------------------------------------------+---------------------------+-------------------------+
| Set current process `trapframe`                                   |                                          |                           | trap.c : `trap`         |
| > `call syscall()`                                                |                                          |                           |                         |
+-------------------------------------------------------------------+------------------------------------------+---------------------------+-------------------------+
| Get trap `num` from the current process `curproc`                 |                                          |                           | syscall.c : `syscall`   |
| `syscalls[num] = sys_close`                                       |                                          |                           |                         |
| > `call sys_close()`                                              |                                          |                           |                         |
+-------------------------------------------------------------------+------------------------------------------+---------------------------+-------------------------+
| Get file descriptor `fd` and struct file `f` from current process |                                          |                           | sysfile.c : `sys_close` |
| zero `fd` refrence in current process                             |                                          |                           |                         |
| > `call fileclose(f)`                                             |                                          |                           |                         |
+-------------------------------------------------------------------+------------------------------------------+---------------------------+-------------------------+
| Decrement `f->ref` count                                          |                                          |                           | file.c : `fileclose`    |
| **`f->ref` is now negative**                                      |                                          |                           |                         |
| > `return` to `sys_close`                                         |                                          |                           |                         |
+-------------------------------------------------------------------+------------------------------------------+---------------------------+-------------------------+
| > `return 0` to `syscall`                                         |                                          |                           | sysfile.c : `sys_close` |
+-------------------------------------------------------------------+------------------------------------------+---------------------------+-------------------------+
| Set `curproc` return value `tr->eax` to `0`                       |                                          |                           | syscall.c : `syscall`   |
| > `return` to `trap`                                              |                                          |                           |                         |
+-------------------------------------------------------------------+------------------------------------------+---------------------------+-------------------------+
| > `return` to `alltraps`                                          |                                          |                           | trap.c : `trap`         |
+-------------------------------------------------------------------+------------------------------------------+---------------------------+-------------------------+
|                                                                   | Pop `trapframe`                          |                           | trapasm.S : `trapret`   |
+-------------------------------------------------------------------+------------------------------------------+---------------------------+-------------------------+
|                                                                   | **Interrupt** : `call alltraps(T_PGFLT)` |                           | vectors.S : `vector14`  |
+-------------------------------------------------------------------+------------------------------------------+---------------------------+-------------------------+
|                                                                   | Build trapframe `tf` for system call     |                           | trapasm.S : `alltraps`  |
|                                                                   | > `call trap(tf)`                        |                           |                         |
+-------------------------------------------------------------------+------------------------------------------+---------------------------+-------------------------+
| `tf->trapno` of `14` indicates user space fault                   |                                          |                           | trap.c : `trap`         |
| **Print page fault**                                              |                                          |                           |                         |
| Set current process as `killed = 1`                               |                                          |                           |                         |
| > `call exit()`                                                   |                                          |                           |                         |
+-------------------------------------------------------------------+------------------------------------------+---------------------------+-------------------------+